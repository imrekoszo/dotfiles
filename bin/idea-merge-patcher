#!/usr/bin/env bash

# Automated way to add the workaround described in
# https://youtrack.jetbrains.com/issue/IDEA-297145
# to the idea script generated by the JetBrains Toolbox
#
# Usage: idea-merge-patcher <generated-script-name>
#

set -e

script_name="${1:-idea}"
script_path=$(which "$script_name") || ( echo 1>&2 "Unable to locate $script_name" ; exit 1 )

# shellcheck disable=SC2016
idea_patch='--- idea
+++ idea
@@ -4,6 +4,10 @@
 declare -a ideargs=()
 declare -- wait=""

+if [[ "$1" = "merge" ]]; then
+  wait="-W"
+fi
+
 for o in "$@"; do
   if [[ "$o" = "--wait" || "$o" = "-w" ]]; then
     wait="-W"
'

(echo "$idea_patch" \
 | patch --fuzz=0 --silent --no-backup-if-mismatch --forward "$script_path" \
 && echo 1>&2 "$script_path successfully patched" ) \
|| (echo 1>&2 "Unable to patch $script_path, it might already be patched, or has unfamiliar contents." \
    && exit 2)
