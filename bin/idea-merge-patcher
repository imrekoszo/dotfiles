#!/bin/bash

# Automated way to add the workaround described in
# https://youtrack.jetbrains.com/issue/IDEA-297145
# to the idea script generated by the JetBrains Toolbox
#
# Usage: idea-merge-patcher <generated-script-name>
#

set -e

script_name="${1:-idea}"
script_path=$(which "$script_name") || ( echo 1>&2 "Unable to locate $script_name" ; exit 1 )

# shellcheck disable=SC2016
original_contents='declare -a ideargs=()
declare -- wait=""

for o in "$@"; do
  if [[ "$o" = "--wait" || "$o" = "-w" ]]; then
    wait="-W"
    o="--wait"
  fi
  if [[ "$o" =~ " " ]]; then
    ideargs+=("\"$o\"")'

# shellcheck disable=SC2016
patched_contents='declare -a ideargs=()
declare -- wait=""

if [[ "$1" = "merge" ]]; then
  wait="-W"
fi

for o in "$@"; do
  if [[ "$o" = "--wait" || "$o" = "-w" ]]; then
    wait="-W"'

current_contents=$(tail -n +4 "$script_path" | head -n 10)

if [[ "$current_contents" = "$patched_contents" ]]; then
  echo 1>&2 "$script_path is already patched"
  exit 0
fi

if [[ "$current_contents" != "$original_contents" ]]; then
  echo 1>&2 "$script_path has unfamiliar contents, cannot patch"
  exit 2
fi

new_contents=$(cat <(head -n 3 "$script_path") <(echo "$patched_contents") <(tail -n +10 "$script_path"))

echo "$new_contents" > "$script_path"

echo 1>&2 "$script_path successfully patched"
